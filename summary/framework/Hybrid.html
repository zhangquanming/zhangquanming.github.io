<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>混合方案简析 | 全明笔记</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="张全明的个人笔记">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.484694f3.css" as="style"><link rel="preload" href="/assets/js/app.07d4e7d8.js" as="script"><link rel="preload" href="/assets/js/2.e756895e.js" as="script"><link rel="preload" href="/assets/js/26.d354a60e.js" as="script"><link rel="prefetch" href="/assets/js/10.9dcd3981.js"><link rel="prefetch" href="/assets/js/11.7c3a4891.js"><link rel="prefetch" href="/assets/js/12.9123d821.js"><link rel="prefetch" href="/assets/js/13.dc2b3bbc.js"><link rel="prefetch" href="/assets/js/14.8e9572dd.js"><link rel="prefetch" href="/assets/js/15.0831d9fb.js"><link rel="prefetch" href="/assets/js/16.fff0091e.js"><link rel="prefetch" href="/assets/js/17.13d701e1.js"><link rel="prefetch" href="/assets/js/18.c01d73d7.js"><link rel="prefetch" href="/assets/js/19.6d8da221.js"><link rel="prefetch" href="/assets/js/20.7e3bfbe7.js"><link rel="prefetch" href="/assets/js/21.d67b0029.js"><link rel="prefetch" href="/assets/js/22.a1d1221b.js"><link rel="prefetch" href="/assets/js/23.97f7c972.js"><link rel="prefetch" href="/assets/js/24.f25bbb61.js"><link rel="prefetch" href="/assets/js/25.886c2813.js"><link rel="prefetch" href="/assets/js/27.8165f251.js"><link rel="prefetch" href="/assets/js/28.38db902f.js"><link rel="prefetch" href="/assets/js/29.d089321c.js"><link rel="prefetch" href="/assets/js/3.c090ecd3.js"><link rel="prefetch" href="/assets/js/30.7f597fdf.js"><link rel="prefetch" href="/assets/js/31.00125d26.js"><link rel="prefetch" href="/assets/js/32.1b584e55.js"><link rel="prefetch" href="/assets/js/33.b6331f3f.js"><link rel="prefetch" href="/assets/js/34.021e8dad.js"><link rel="prefetch" href="/assets/js/35.2b1e189b.js"><link rel="prefetch" href="/assets/js/36.4643cf1b.js"><link rel="prefetch" href="/assets/js/37.ff936690.js"><link rel="prefetch" href="/assets/js/4.55092137.js"><link rel="prefetch" href="/assets/js/5.02018b5a.js"><link rel="prefetch" href="/assets/js/6.bd7b0c2a.js"><link rel="prefetch" href="/assets/js/7.711e75c5.js"><link rel="prefetch" href="/assets/js/8.35b709e8.js"><link rel="prefetch" href="/assets/js/9.029996af.js">
    <link rel="stylesheet" href="/assets/css/0.styles.484694f3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">全明笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/summary/" class="nav-link router-link-active">
  知识总结
</a></div><div class="nav-item"><a href="/utils/" class="nav-link">
  工具类
</a></div><div class="nav-item"><a href="/links/" class="nav-link">
  学习资料
</a></div><div class="nav-item"><a href="/code/" class="nav-link">
  手写代码
</a></div><div class="nav-item"><a href="https://www.mingme.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zhangquanming/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/summary/" class="nav-link router-link-active">
  知识总结
</a></div><div class="nav-item"><a href="/utils/" class="nav-link">
  工具类
</a></div><div class="nav-item"><a href="/links/" class="nav-link">
  学习资料
</a></div><div class="nav-item"><a href="/code/" class="nav-link">
  手写代码
</a></div><div class="nav-item"><a href="https://www.mingme.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zhangquanming/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>知识总结</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/" aria-current="page" class="sidebar-link">前言</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/css/base.html" class="sidebar-link">CSS基础知识</a></li><li><a href="/summary/css/layout.html" class="sidebar-link">常见布局方式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript 相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/javascript/" class="sidebar-link">JavaScript基础知识</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>浏览器与网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/http/web.html" class="sidebar-link">浏览器</a></li><li><a href="/summary/http/service.html" class="sidebar-link">服务端与网络</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端框架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/framework/vue.html" class="sidebar-link">Vue</a></li><li><a href="/summary/framework/react.html" class="sidebar-link">React</a></li><li><a href="/summary/framework/Hybrid.html" aria-current="page" class="active sidebar-link">Hybrid</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/summary/framework/Hybrid.html#混合方案简析" class="sidebar-link">混合方案简析</a></li><li class="sidebar-sub-header"><a href="/summary/framework/Hybrid.html#webview" class="sidebar-link">Webview</a></li><li class="sidebar-sub-header"><a href="/summary/framework/Hybrid.html#交互原理" class="sidebar-link">交互原理</a></li><li class="sidebar-sub-header"><a href="/summary/framework/Hybrid.html#接入方案" class="sidebar-link">接入方案</a></li><li class="sidebar-sub-header"><a href="/summary/framework/Hybrid.html#优化方案简述" class="sidebar-link">优化方案简述</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>构建工具</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/bundler/webpack.html" class="sidebar-link">Webpack</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工程化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/monitor/monitor.html" class="sidebar-link">前端监控</a></li><li><a href="/summary/performance/performance.html" class="sidebar-link">项目性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>全栈基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/other/node.html" class="sidebar-link">Node</a></li><li><a href="/summary/other/nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/summary/other/docker.html" class="sidebar-link">Docker</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="混合方案简析"><a href="#混合方案简析" class="header-anchor">#</a> 混合方案简析</h2> <p>Hybrid App，俗称 <strong>混合应用</strong>，即混合了 Native 技术 与 Web 技术 进行开发的移动应用。现在比较流行的混合方案主要有三种，主要是在 UI 渲染机制上的不同:</p> <ul><li><p><strong>Webview UI</strong></p> <ul><li>通过 JSBridge 完成 H5 与 Native 的双向通讯，并 <strong>基于 Webview</strong> 进行页面的渲染；</li> <li><strong>优势</strong>: 简单易用，架构门槛/成本较低，适用性与灵活性极强；</li> <li><strong>劣势</strong>: Webview 性能局限，在复杂页面中，表现远不如原生页面；</li></ul></li> <li><p><strong>Native UI</strong></p> <ul><li>通过 JSBridge 赋予 H5 原生能力，并进一步将 JS 生成的虚拟节点树(Virtual DOM)传递至 Native 层，并使用 <strong>原生系统渲染</strong>。</li> <li><strong>优势</strong>: 用户体验基本接近原生，且能发挥 Web 技术 开发灵活与易更新的特性；</li> <li><strong>劣势</strong>: 上手/改造门槛较高，最好需要掌握一定程度的客户端技术。相比于常规 Web 开发，需要更高的开发调试、问题排查成本；</li></ul></li> <li><p><strong>小程序</strong></p> <ul><li>通过更加定制化的 JSBridge，赋予了 Web 更大的权限，并使用双 WebView 双线程的模式隔离了 JS 逻辑 与 UI 渲染，形成了特殊的开发模式，加强了 H5 与 Native 混合程度，属于第一种方案的优化版本；</li> <li><strong>优势</strong>: 用户体验好于常规 Webview 方案，且通常依托的平台也能提供更为友好的开发调试体验以及功能；</li> <li><strong>劣势</strong>: 需要依托于特定的平台的规范限定</li></ul></li></ul> <h2 id="webview"><a href="#webview" class="header-anchor">#</a> Webview</h2> <p>Webview 是 Native App 中内置的一款基于 Webkit 内核 的浏览器，主要由两部分组成:</p> <ul><li><strong>WebCore 排版引擎</strong></li> <li><strong>JSCore 解析引擎</strong></li></ul> <p>在原生开发 SDK 中 Webview 被封装成了一个组件，用于作为 Web 页面 的容器。因此，作为宿主的客户端中拥有更高的权限，可以对 Webview 中的 Web 页面 进行配置和开发。</p> <p>Hybrid 技术中双端的交互原理，便是基于 Webview 的一些 API 和特性。</p> <h2 id="交互原理"><a href="#交互原理" class="header-anchor">#</a> 交互原理</h2> <p>Hybrid 技术 中最核心的点就是 Native 端 与 H5 端 之间的 <strong>双向通讯层</strong>，其实这里也可以理解为我们需要一套 <strong>跨语言通讯方案</strong>，便是我们常听到的 JSBridge。</p> <ul><li><p><strong>JavaScript 通知 Native</strong></p> <ul><li><strong>API 注入</strong>，Native 直接在 JS 上下文中挂载数据或者方法
<ul><li>延迟较低，在安卓 4.1 以下具有安全性问题，风险较高</li></ul></li> <li>WebView <strong>URL Scheme</strong> 跳转拦截
<ul><li>兼容性好，但延迟较高，且有长度限制</li></ul></li> <li>WebView 中的 <strong>prompt/console/alert</strong> 拦截(通常使用 prompt)</li></ul></li> <li><p><strong>Native 通知 Javascript</strong></p> <ul><li><strong>IOS</strong>: <code>stringByEvaluatingJavaScriptFromString</code></li></ul> <div class="language- extra-class"><pre class="language-text"><code>// Swift
webview.stringByEvaluatingJavaScriptFromString(&quot;alert('NativeCall')&quot;)
</code></pre></div><ul><li><strong>Android</strong>: <code>loadUrl</code> (4.4-)</li></ul> <div class="language- extra-class"><pre class="language-text"><code>// 调用js中的JSBridge.trigger方法
// 该方法的弊端是无法获取函数返回值；
webView.loadUrl(&quot;javascript:JSBridge.trigger('NativeCall')&quot;)
</code></pre></div><ul><li><strong>Android</strong>: <code>evaluateJavascript</code> (4.4+)</li></ul> <div class="language- extra-class"><pre class="language-text"><code>// 4.4+后使用该方法便可调用并获取函数返回值；
mWebView.evaluateJavascript（&quot;javascript:JSBridge.trigger('NativeCall')&quot;, 	 new ValueCallback&lt;String&gt;() {
    @Override
    public void onReceiveValue(String value) {
        //此处为 js 返回的结果
    }
});
</code></pre></div></li></ul> <h2 id="接入方案"><a href="#接入方案" class="header-anchor">#</a> 接入方案</h2> <p>整套方案需要 Web 与 Native 两部分共同来完成:</p> <ul><li><strong>Native</strong>: 负责实现 URL 拦截与解析、环境信息的注入、拓展功能的映射、版本更新等功能。</li> <li><strong>JavaScirpt</strong>: 负责实现功能协议的拼装、协议的发送、参数的传递、回调等一系列基础功能。</li></ul> <h4 id="接入方式"><a href="#接入方式" class="header-anchor">#</a> 接入方式:</h4> <ul><li><p><strong>在线 H5</strong>: 直接将项目部署于线上服务器，并由客户端在 HTML 头部注入对应的 Bridge。</p> <ul><li><strong>优势</strong>: 接入/开发成本低，对 App 的侵入小。</li> <li><strong>劣势</strong>: 重度依赖网络，无法离线使用，首屏加载慢。</li></ul></li> <li><p><strong>内置离线包</strong>: 将代码直接内置于 App 中，即本地存储中，可由 H5 或者 客户端引用 Bridge。</p> <ul><li><strong>优势</strong>: 首屏加载快，可离线化使用。</li> <li><strong>劣势</strong>: 开发、调试成本变高，需要多端合作，且会增加 App 包体积。</li></ul></li></ul> <h2 id="优化方案简述"><a href="#优化方案简述" class="header-anchor">#</a> 优化方案简述</h2> <ul><li><p><strong>Webview 预加载</strong>: Webview 的初始化其实挺耗时的。我们测试过，大概在 100~200ms 之间，因此如果能前置做好初始化于内存中，会大大加快渲染速度。</p></li> <li><p><strong>更新机制</strong>: 使用离线包的时候，便会涉及到本地离线代码的更新问题，因此需要建立一套云端下发包的机制，由客户端下载云端最新代码包 (zip 包)，并解压替换本地代码。</p> <ul><li><p><strong>增量更新</strong>: 由于下发包是一个下载的过程，因此包的体积越小，下载速度越快，流量损耗越低。只打包改变的文件，客户端下载后覆盖式替换，能大大减小每次更新包的体积。</p></li> <li><p><strong>条件分发</strong>: 云平台下发更新包时，可以配合客户端设置一系列的条件与规则，从而实现代码的条件更新:</p> <ul><li>单 <strong>地区</strong> 更新: 例如一个只有中国地区才能更新的版本。</li> <li>按 <strong>语言</strong> 更新: 例如只有中文版本会更新。</li> <li>按 App <strong>版本</strong> 更新: 例如只有最新版本的 App 才会更新。</li> <li><strong>灰度</strong> 更新: 只有小比例用户会更新。</li> <li><strong>AB 测试</strong>: 只有命中的用户会更新。</li></ul></li></ul></li> <li><p><strong>降级机制</strong>: 当用户下载或解压代码包失败时，需要有套降级方案，通常有两种做法:</p> <ul><li><strong>本地内置</strong>: 随着 App 打包时内置一份线上最新完整代码包，保证本地代码文件的存在，资源加载均使用本地化路径。</li> <li><strong>域名拦截</strong>: 资源加载使用线上域名，通过拦截域名映射到本地路径。当本地不存在时，则请求线上文件，当存在时，直接加载。</li></ul></li> <li><p><strong>跨平台部署</strong>: Bridge 层 可以做一套浏览器适配，在一些无法适配的功能，做好降级处理，从而保证代码在任何环境的可用性，一套代码可同时运行于 App 内 与 普通浏览器。</p></li> <li><p><strong>环境系统</strong>: 与客户端进行统一配合，搭建出 <strong>正式 / 预上线 / 测试 / 开发</strong> 环境，能大大提高项目稳定性与问题排查。</p></li> <li><p><strong>开发模式</strong>:</p> <ul><li>能连接 PC Chrome/safari 进行代码调试。</li> <li>具有开发调试入口，可以使用同样的 Webview 加载开发时的本地代码。</li> <li>具备日志系统，可以查看 Log 信息。</li></ul></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/3/2024, 4:38:41 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/summary/framework/react.html" class="prev">
        React
      </a></span> <span class="next"><a href="/summary/bundler/webpack.html">
        Webpack
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.07d4e7d8.js" defer></script><script src="/assets/js/2.e756895e.js" defer></script><script src="/assets/js/26.d354a60e.js" defer></script>
  </body>
</html>
