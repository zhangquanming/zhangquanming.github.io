<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、为什么要做前端监控 | 全明笔记</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="张全明的个人笔记">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.484694f3.css" as="style"><link rel="preload" href="/assets/js/app.07d4e7d8.js" as="script"><link rel="preload" href="/assets/js/2.e756895e.js" as="script"><link rel="preload" href="/assets/js/32.1b584e55.js" as="script"><link rel="prefetch" href="/assets/js/10.9dcd3981.js"><link rel="prefetch" href="/assets/js/11.7c3a4891.js"><link rel="prefetch" href="/assets/js/12.9123d821.js"><link rel="prefetch" href="/assets/js/13.dc2b3bbc.js"><link rel="prefetch" href="/assets/js/14.8e9572dd.js"><link rel="prefetch" href="/assets/js/15.0831d9fb.js"><link rel="prefetch" href="/assets/js/16.fff0091e.js"><link rel="prefetch" href="/assets/js/17.13d701e1.js"><link rel="prefetch" href="/assets/js/18.c01d73d7.js"><link rel="prefetch" href="/assets/js/19.6d8da221.js"><link rel="prefetch" href="/assets/js/20.7e3bfbe7.js"><link rel="prefetch" href="/assets/js/21.d67b0029.js"><link rel="prefetch" href="/assets/js/22.a1d1221b.js"><link rel="prefetch" href="/assets/js/23.97f7c972.js"><link rel="prefetch" href="/assets/js/24.f25bbb61.js"><link rel="prefetch" href="/assets/js/25.886c2813.js"><link rel="prefetch" href="/assets/js/26.d354a60e.js"><link rel="prefetch" href="/assets/js/27.8165f251.js"><link rel="prefetch" href="/assets/js/28.38db902f.js"><link rel="prefetch" href="/assets/js/29.d089321c.js"><link rel="prefetch" href="/assets/js/3.c090ecd3.js"><link rel="prefetch" href="/assets/js/30.7f597fdf.js"><link rel="prefetch" href="/assets/js/31.00125d26.js"><link rel="prefetch" href="/assets/js/33.b6331f3f.js"><link rel="prefetch" href="/assets/js/34.021e8dad.js"><link rel="prefetch" href="/assets/js/35.2b1e189b.js"><link rel="prefetch" href="/assets/js/36.4643cf1b.js"><link rel="prefetch" href="/assets/js/37.ff936690.js"><link rel="prefetch" href="/assets/js/4.55092137.js"><link rel="prefetch" href="/assets/js/5.02018b5a.js"><link rel="prefetch" href="/assets/js/6.bd7b0c2a.js"><link rel="prefetch" href="/assets/js/7.711e75c5.js"><link rel="prefetch" href="/assets/js/8.35b709e8.js"><link rel="prefetch" href="/assets/js/9.029996af.js">
    <link rel="stylesheet" href="/assets/css/0.styles.484694f3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">全明笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/summary/" class="nav-link router-link-active">
  知识总结
</a></div><div class="nav-item"><a href="/utils/" class="nav-link">
  工具类
</a></div><div class="nav-item"><a href="/links/" class="nav-link">
  学习资料
</a></div><div class="nav-item"><a href="/code/" class="nav-link">
  手写代码
</a></div><div class="nav-item"><a href="https://www.mingme.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zhangquanming/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/summary/" class="nav-link router-link-active">
  知识总结
</a></div><div class="nav-item"><a href="/utils/" class="nav-link">
  工具类
</a></div><div class="nav-item"><a href="/links/" class="nav-link">
  学习资料
</a></div><div class="nav-item"><a href="/code/" class="nav-link">
  手写代码
</a></div><div class="nav-item"><a href="https://www.mingme.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zhangquanming/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>知识总结</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/" aria-current="page" class="sidebar-link">前言</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/css/base.html" class="sidebar-link">CSS基础知识</a></li><li><a href="/summary/css/layout.html" class="sidebar-link">常见布局方式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript 相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/javascript/" class="sidebar-link">JavaScript基础知识</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>浏览器与网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/http/web.html" class="sidebar-link">浏览器</a></li><li><a href="/summary/http/service.html" class="sidebar-link">服务端与网络</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端框架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/framework/vue.html" class="sidebar-link">Vue</a></li><li><a href="/summary/framework/react.html" class="sidebar-link">React</a></li><li><a href="/summary/framework/Hybrid.html" class="sidebar-link">Hybrid</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>构建工具</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/bundler/webpack.html" class="sidebar-link">Webpack</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>工程化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/monitor/monitor.html" aria-current="page" class="active sidebar-link">前端监控</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#一、为什么要做前端监控" class="sidebar-link">一、为什么要做前端监控</a></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#二、前端数据分类" class="sidebar-link">二、前端数据分类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#_2-1-访问相关的数据" class="sidebar-link">2.1 访问相关的数据</a></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#_2-2-性能相关的数据" class="sidebar-link">2.2 性能相关的数据</a></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#_2-3-点击相关的数据" class="sidebar-link">2.3 点击相关的数据</a></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#_2-4-异常相关的数据" class="sidebar-link">2.4 异常相关的数据</a></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#_2-5-其它数据" class="sidebar-link">2.5 其它数据</a></li></ul></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#三、性能指标" class="sidebar-link">三、性能指标</a></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#四、前端监控目标-监控分类" class="sidebar-link">四、前端监控目标(监控分类)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#_4-1-稳定性-stability" class="sidebar-link">4.1 稳定性(stability)</a></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#_4-2-用户体验-experience" class="sidebar-link">4.2 用户体验(experience)</a></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#_4-3-业务" class="sidebar-link">4.3 业务</a></li></ul></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#五、前端监控流程" class="sidebar-link">五、前端监控流程</a></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#六、常见的埋点方案" class="sidebar-link">六、常见的埋点方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#_6-1-代码埋点" class="sidebar-link">6.1 代码埋点</a></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#_6-2-可视化埋点" class="sidebar-link">6.2 可视化埋点</a></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#_6-3-无痕埋点" class="sidebar-link">6.3 无痕埋点</a></li></ul></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#七、编写监控采集脚本" class="sidebar-link">七、编写监控采集脚本</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#_7-1-监控错误" class="sidebar-link">7.1 监控错误</a></li><li class="sidebar-sub-header"><a href="/summary/monitor/monitor.html#_7-2-数据结构设计" class="sidebar-link">7.2 数据结构设计</a></li></ul></li></ul></li><li><a href="/summary/performance/performance.html" class="sidebar-link">项目性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>全栈基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/other/node.html" class="sidebar-link">Node</a></li><li><a href="/summary/other/nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/summary/other/docker.html" class="sidebar-link">Docker</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="一、为什么要做前端监控"><a href="#一、为什么要做前端监控" class="header-anchor">#</a> 一、为什么要做前端监控</h2> <ul><li>更快的发现问题</li> <li>做产品决策依据</li> <li>提升前端开发的技术深度和广度</li> <li>为业务扩展提供更多可能性</li></ul> <h2 id="二、前端数据分类"><a href="#二、前端数据分类" class="header-anchor">#</a> 二、前端数据分类</h2> <p>前端的数据其实有很多，从大众普遍关注的 PV、UV、广告点击量，到客户端的网络环境、登陆状态，再到浏览器、操作系统信息，最后到页面性能、JS 异常，这些数据都可以在前端收集到。</p> <h3 id="_2-1-访问相关的数据"><a href="#_2-1-访问相关的数据" class="header-anchor">#</a> 2.1 访问相关的数据</h3> <ul><li>PV/UV:最基础的 PV(页面访问量)、UV(独立访问用户数据量)</li> <li>页面来源：页面的 referer,可以定位页面的入口</li> <li>操作系统：了解用户的 OS 情况，帮助分析用户群体的特征，特别是移动端、iOS 和 Android 的分布就更有意义了</li> <li>浏览器：可以统计到各种浏览器的占比，对于是否继续兼容 IE6、新技术(HTML5、CSS3 等)的运用等调研提供参考价值</li> <li>分辨率：对页面设计提供参考，特别是响应式设计</li> <li>登录率：登陆用户具有更高的分析价值，引导用户登陆是非常重要的</li> <li>地域分布：访问用户在地理位置上的分布，可以针对不同地域做运营、活动等</li> <li>网络类型：wifi/3G/2G，为产品是否需要适配不同网络环境做决策</li> <li>访问时段：掌握用户访问时间的分布，引导消峰填谷、节省带宽</li> <li>停留时长：判断页面内容是否具有吸引力，对于需要长时间阅读的页面比较有意义</li> <li>到达深度：和停留时长类似，例如百度百科，用户浏览时的页面到达深度直接反映词条的质量</li></ul> <h3 id="_2-2-性能相关的数据"><a href="#_2-2-性能相关的数据" class="header-anchor">#</a> 2.2 性能相关的数据</h3> <ul><li>白屏时间：用户从打开页面开始到页面开始有东西呈现为止，这过程中占用的时间就是白屏时间</li> <li>首屏时间：用户浏览器首屏内所有内容都呈现出来所花费的时间</li> <li>用户可操作时间：用户可以进行正常的点击、输入等操作</li> <li>页面总下载时间：页面所有资源都加载完成并呈现出来所花的时间，即页面 onload 的时间</li> <li>自定义的时间点：对于开发人员来说，完全可以自定义一些时间点，例如：某个组件 init 完成的时间、某个重要模块加载的时间等等</li></ul> <h3 id="_2-3-点击相关的数据"><a href="#_2-3-点击相关的数据" class="header-anchor">#</a> 2.3 点击相关的数据</h3> <ul><li>页面总点击量</li> <li>人均点击量：对于导航类的网页，这项指标是非常重要的</li> <li>流出 url：同样，导航类的网页，直接了解网页导流的去向</li> <li>点击时间：用户的所有点击行为，在时间上的分布，反映了用户点击操作的习惯</li> <li>首次点击时间：同上，但是只统计用户的第一次点击，如果该时间偏大，是否就表明页面很卡导致用户长时间不能点击呢？</li> <li>点击热力图：根据用户点击的位置，我们可以画出整个页面的点击热力图，可以很直观的了解到页面的热点区域</li></ul> <h3 id="_2-4-异常相关的数据"><a href="#_2-4-异常相关的数据" class="header-anchor">#</a> 2.4 异常相关的数据</h3> <p>这里的异常是指 JS 的异常，用户的浏览器上报 JS 的 bug，这会极大地降低用户体验</p> <ul><li>异常的提示信息：这是识别一个异常的最重要依据，如：e.src 为空或不是对象</li> <li>JS 文件名</li> <li>异常所在行</li> <li>发生异常的浏览器</li> <li>堆栈信息：必要的时候需要函数调用的堆栈信息，但是注意堆栈信息可能会比较大，需要截取</li></ul> <h3 id="_2-5-其它数据"><a href="#_2-5-其它数据" class="header-anchor">#</a> 2.5 其它数据</h3> <p>除了上面提到的 4 类基本的数据统计需求，我们当然还可以根据实际情况来定义一些其他的统计需求，如用户浏览器对 canvas 的支持程度， 再比如比较特殊的-用户进行轮播图翻页的次数，这些数据统计需求都是前端能够满足的，每一项统计的结果都体现了前端数据的价值</p> <h2 id="三、性能指标"><a href="#三、性能指标" class="header-anchor">#</a> 三、性能指标</h2> <ul><li>FP(First Paint)：首次绘制时间，包括了任何用户自定义的背景绘制，它是首先将像素绘制到屏幕的时刻。</li> <li>FCP(First Content Paint)：首次内容绘制。是浏览器将第一个 DOM 渲染到屏幕的时间，可能是文本、图像、SVG 等。这其实就是白屏时间</li> <li>FMP(First Meaningful Paint)：首次有意义绘制。页面有意义的内容渲染的时间</li> <li>LCP(Largest Contentful Paint)。最大内容渲染。代表在 viewport 中最大的页面元素加载的时间。</li> <li>DCL(DomContentLoaded)：DOM 加载完成。当 HTML 文档被完全加载和解析完成之后，DOMContentLoaded 事件被触发。无需等待样式表，图像和子框架的完成加载。</li> <li>L(onload)：当依赖的资源全部加载完毕之后才会触发。</li> <li>TTI(Time to Interactive)：可交互时间。用于标记应用已进行视觉渲染并能可靠响应用户输入的时间点。</li> <li>FID(First Input Delay)：首次输入延迟。用户首次和页面交互(单击链接、点击按钮等)到页面响应交互的时间。</li></ul> <h2 id="四、前端监控目标-监控分类"><a href="#四、前端监控目标-监控分类" class="header-anchor">#</a> 四、前端监控目标(监控分类)</h2> <h3 id="_4-1-稳定性-stability"><a href="#_4-1-稳定性-stability" class="header-anchor">#</a> 4.1 稳定性(stability)</h3> <ul><li>JS 错误，JS 执行错误或者 Promise 异常</li> <li>资源异常，script、link 等资源加载异常</li> <li>接口错误,ajax 或 fetch 请求接口异常</li> <li>白屏，页面空白</li></ul> <h3 id="_4-2-用户体验-experience"><a href="#_4-2-用户体验-experience" class="header-anchor">#</a> 4.2 用户体验(experience)</h3> <ul><li>加载时间，各个阶段的加载时间</li> <li>TTFB(Time To First Byte 首字节时间)。是指浏览器发起第一个请求到数据返回第一个字节所消耗的时间，这个时间包含了网络请求时间、后端处理时间。</li> <li>FP(First Paint 首次绘制)。首次绘制包括了任何用户自定义的背景绘制，它是将第一个像素点绘制到屏幕的时间。</li> <li>FCP(First Content Paint 首次内容绘制)。首次内容绘制是浏览器将第一个 DOM 渲染到屏幕的时间，可以是任何文本、图像、SVG 等的时间。</li> <li>FMP(First Meaningful Paint 首次有意义绘制)。 首次有意义绘制是页面可用性的量度标准。</li> <li>FID(First Input Delay 首次输入延迟)。用户首次和页面交互到页面响应交互的时间。</li> <li>卡顿。 超过 50ms 的任务。</li></ul> <h3 id="_4-3-业务"><a href="#_4-3-业务" class="header-anchor">#</a> 4.3 业务</h3> <ul><li>PV：page view 即页面浏览量或点击量</li> <li>UV：指访问某个站点的不同 IP 地址的人数。</li> <li>页面停留时间：用户在每一个页面的停留时间。</li></ul> <h2 id="五、前端监控流程"><a href="#五、前端监控流程" class="header-anchor">#</a> 五、前端监控流程</h2> <ul><li>数据埋点</li> <li>数据上报</li> <li>分析和计算，将采集到的数据进行加工总结</li> <li>可视化展示，将数据按照各种维度进行展示</li> <li>监控报警，发现问题后按一定的条件触发报警</li></ul> <h2 id="六、常见的埋点方案"><a href="#六、常见的埋点方案" class="header-anchor">#</a> 六、常见的埋点方案</h2> <h3 id="_6-1-代码埋点"><a href="#_6-1-代码埋点" class="header-anchor">#</a> 6.1 代码埋点</h3> <ul><li>代码埋点，就是以嵌入代码的形式进行埋点，比如要监控用户的点击事件，会选择在用户点击时插入一段代码，保存这个监听行为或者直接将监听行为 以某一种数据格式直接传递给服务器端。</li> <li>优点是可以在任意时刻，精确的发送或保存所需要的数据信息。</li> <li>缺点就是工作量大</li></ul> <h3 id="_6-2-可视化埋点"><a href="#_6-2-可视化埋点" class="header-anchor">#</a> 6.2 可视化埋点</h3> <ul><li>通过可视化交互的手段，代替代码埋点。</li> <li>将业务代码和埋点代码分离，提供一个可视化交互的页面，输入为业务代码，通过这个可视化系统，可以在业务代码中自定义 的增加埋点事件等等。最后输出的代码耦合了业务代码和埋点代码</li> <li>可视化埋点其实是用系统来代替手工插入埋点代码。</li></ul> <h3 id="_6-3-无痕埋点"><a href="#_6-3-无痕埋点" class="header-anchor">#</a> 6.3 无痕埋点</h3> <ul><li>前端的任意一个事件都被绑定一个标识，所有的事件都被记录下来。</li> <li>通过定期上传记录文件，配合文件解析，解析出来我们想要的数据，并生成可视化报告供专业人员分析</li> <li>无痕埋点的优点是采集全量数据，不会出现漏埋和误埋等现象</li> <li>缺点是给数据传输和服务器增加压力，也无法灵活定制数据结构</li></ul> <h2 id="七、编写监控采集脚本"><a href="#七、编写监控采集脚本" class="header-anchor">#</a> 七、编写监控采集脚本</h2> <h3 id="_7-1-监控错误"><a href="#_7-1-监控错误" class="header-anchor">#</a> 7.1 监控错误</h3> <ul><li>错误分类</li> <li>JS 错误</li> <li>Promise 异常</li> <li>资源异常</li> <li>监听 error</li></ul> <h3 id="_7-2-数据结构设计"><a href="#_7-2-数据结构设计" class="header-anchor">#</a> 7.2 数据结构设计</h3> <ul><li>jsError</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> info <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'前端监控系统'</span><span class="token punctuation">,</span> <span class="token comment">// 页面标题</span>
  <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'http://localhost:8080'</span><span class="token punctuation">,</span> <span class="token comment">// 页面 url</span>
  <span class="token literal-property property">timestamp</span><span class="token operator">:</span> <span class="token string">'1212121212121212'</span><span class="token punctuation">,</span> <span class="token comment">// 访问时间戳</span>
  <span class="token literal-property property">userAgent</span><span class="token operator">:</span> <span class="token string">'chrome'</span><span class="token punctuation">,</span> <span class="token comment">// 用户浏览器类型</span>
  <span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'stability'</span><span class="token punctuation">,</span> <span class="token comment">// 大类</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token comment">// 小类</span>
  <span class="token literal-property property">errorType</span><span class="token operator">:</span> <span class="token string">'jsError'</span><span class="token punctuation">,</span> <span class="token comment">// 错误类型</span>
  <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'uncaught TypeError:blablabla'</span><span class="token punctuation">,</span> <span class="token comment">// 错误详情</span>
  <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'http://localhost:8080/'</span><span class="token punctuation">,</span> <span class="token comment">// 访问的文件名</span>
  <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'0:0'</span><span class="token punctuation">,</span> <span class="token comment">// 行列信息</span>
  <span class="token literal-property property">stack</span><span class="token operator">:</span> <span class="token string">'btn Click (http://localhost:8080)'</span><span class="token punctuation">,</span> <span class="token comment">// 堆栈信息</span>
  <span class="token literal-property property">selector</span><span class="token operator">:</span> <span class="token string">'HTML BODY #container .content INPUT'</span><span class="token punctuation">,</span> <span class="token comment">// 选择器</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>接口异常数据结构设置</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> info <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'前端监控系统'</span><span class="token punctuation">,</span> <span class="token comment">// 页面标题</span>
  <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'http://localhost:8080'</span><span class="token punctuation">,</span> <span class="token comment">// 页面 url</span>
  <span class="token literal-property property">timestamp</span><span class="token operator">:</span> <span class="token string">'1212121212121212'</span><span class="token punctuation">,</span> <span class="token comment">// 访问时间戳</span>
  <span class="token literal-property property">userAgent</span><span class="token operator">:</span> <span class="token string">'chrome'</span><span class="token punctuation">,</span> <span class="token comment">// 用户浏览器类型</span>
  <span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'stability'</span><span class="token punctuation">,</span> <span class="token comment">// 大类</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'xhr'</span><span class="token punctuation">,</span> <span class="token comment">// 小类</span>
  <span class="token literal-property property">eventType</span><span class="token operator">:</span> <span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token comment">// 事件类型</span>
  <span class="token literal-property property">pathname</span><span class="token operator">:</span> <span class="token string">'/success'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'200-0k'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token string">'5'</span><span class="token punctuation">,</span> <span class="token comment">// 持续时间</span>
  <span class="token literal-property property">response</span><span class="token operator">:</span> <span class="token string">'hahah'</span><span class="token punctuation">,</span> <span class="token comment">// 响应内容</span>
  <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token string">'参数'</span><span class="token punctuation">,</span> <span class="token comment">// 参数</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>白屏 screen 返回当前 window 的 screen 对象，返回当前渲染窗口中和屏幕有关的属性
<ul><li>innerWidth 只读的 window 属性。innerWidth 返回以像素为单位的窗口的内部宽度</li> <li>innerHeight 窗口的内部高度(布局视口)的高度</li> <li>layout*viewport</li> <li>elementsFromPoint 方法可以获取到当前视口内指定坐标处，由里到外排列的所有元素。</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> info <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'前端监控系统'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'http://localhost:8080/'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">timestamp</span><span class="token operator">:</span> <span class="token string">'1239404040404044'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">userAgent</span><span class="token operator">:</span> <span class="token string">'chorme'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'stability'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'blank'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">emptyPoints</span><span class="token operator">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token comment">// 空白点</span>
  <span class="token literal-property property">screen</span><span class="token operator">:</span> <span class="token string">'2049 * 1152'</span><span class="token punctuation">,</span> <span class="token comment">// 分辨率</span>
  <span class="token literal-property property">viewPoint</span><span class="token operator">:</span> <span class="token string">'2048 _ 994'</span><span class="token punctuation">,</span> <span class="token comment">// 视口</span>
  <span class="token literal-property property">selector</span><span class="token operator">:</span> <span class="token string">'HTML BODY #container'</span><span class="token punctuation">,</span> <span class="token comment">// 选择器</span>
<span class="token punctuation">}</span>
</code></pre></div><p>整体大致可以分四个阶段：信息采集、存储、分析、监控。</p> <ul><li><p>采集阶段：收集异常日志，先在本地做一定的处理，采取一定的方案上报到服务器。</p></li> <li><p>存储阶段：后端接收前端上报的异常日志，经过一定处理，按照一定的存储方案存储。</p></li> <li><p>分析阶段：分为机器自动分析和人工分析。机器自动分析，通过预设的条件和算法，对存储的日志信息进行统计和筛选，发现问题，触发报警。人工分析，通过提供一个可视化的数据面板，让系统用户可以看到具体的日志数据，根据信息，发现异常问题根源。</p></li> <li><p>报警阶段：分为告警和预警。告警按照一定的级别自动报警，通过设定的渠道，按照一定的触发规则进行。预警则在异常发生前，提前预判，给出警告。</p></li> <li><p>性能监控： 使用 Resource Timing API 和 Performance Timing API，可以计算许多重要的指标，比如页面性能统计的起始点时间、首屏时间等。</p></li> <li><p>异常监控： 前端捕获异常分为全局捕获和局部捕获。局部捕获作为补充，对某些特殊情况进行捕获，但分散，不利于管理。所以，我会选择全局捕获的方式，即通过全局的接口，将捕获代码集中写在一个地方。具体在实现项目中，我应该会采用 badjs-report，它重写了 window.onerror 进行上报异常，无需编写任何捕获错误的代码。</p></li> <li><p>前端埋点： 埋点的方案有手动埋点，即在需要监控的地方插入监控逻辑，但是工作量可能会很大；还有无埋点，前端自动采集全部事件，上报埋点数据，但是缺点是服务器压力会很大。我可能倾向于采用声明式埋点，将埋点代码和具体的业务逻辑解耦，只用关心需要埋点的控件，并且为这些控件声明需要的埋点数据即可，主要是为了降低埋点的成本吧。在 dom 元素上增添埋点信息，比如</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// key 表示埋点的唯一标识；act 表示埋点方式</span>
<span class="token operator">&lt;</span>button data<span class="token operator">-</span>stat<span class="token operator">=</span><span class="token string">&quot;{key:'buttonKey', act: 'click'}&quot;</span><span class="token operator">&gt;</span>埋点<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
</code></pre></div><ul><li><p>监控告警： 这里我认为最便捷、高效的方式，就是接入内部的告警组了吧，尤其是在阿里，似乎什么轮子都有，那可能需要考虑就是触发告警的阈值和时机了。</p></li> <li><p>性能：使用 Performance API，可以得到许多重要的指标，如页面性能统计的起始点时间、首屏时间等</p></li> <li><p>报错：使用 onerror 和 onunhandledrejection，甚至是 try catch</p></li> <li><p>操作行为：对事件触发函数做 patch，或者添加特定的事件监听</p></li> <li><p>PV/UV：利用浏览器存储方法或 Cookie、IP 等储存相应用户信息，随请求发送</p></li> <li><p>设备信息：获取 navigator.userAgent</p></li> <li><p>PV、UV 属于增长数字类型，可以用 Redis 等记录，如果有需要，定时入库。其他属于大量文字信息，可以用成熟的消息队列来消费。因为有大量写，所以可以考虑做读写分离。</p></li> <li><p>技术难点：</p> <ul><li><p>可能整个系统比较复杂的就是如何高效合理的进行监控数据上传。除了异常报错信息本身，还需要记录用户操作日志，如果任何日志都立即上报，这无异于自造的 DDOS 攻击。那就需要考虑前端日志的存储，日志如何上传，上传前如何整理日志等问题。</p></li> <li><p>前端在收集的过程中可能会影响用户体验。</p></li> <li><p>后端对于收到的日志要使用合适的工具进行收集，数据量大时选择如何取舍。</p></li></ul></li> <li><p>可能会采取的方案</p> <ul><li>indexDB 存储日志，因为容量大、异步！不用考虑阻塞页面问题。</li> <li>在一个 webworker 中对日志进行整理，比如对每一条日志打上标签，进行分类等操作。</li> <li>上报日志也在 webworker 中进行，可以按照重要紧急度区分，判断是否延时或者立即上报。</li></ul></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/18/2022, 5:42:50 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/summary/bundler/webpack.html" class="prev">
        Webpack
      </a></span> <span class="next"><a href="/summary/performance/performance.html">
        项目性能优化
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.07d4e7d8.js" defer></script><script src="/assets/js/2.e756895e.js" defer></script><script src="/assets/js/32.1b584e55.js" defer></script>
  </body>
</html>
